PROJECT_NAME := ethernet_video

TARGET ?= tangprimer20k
ROOT_DIR ?= $(abspath ../..)
RTL_DIR ?= $(ROOT_DIR)/rtl
ETHERNET_DIR ?= $(RTL_DIR)/ethernet

MII_MAC_SRC := $(wildcard $(ETHERNET_DIR)/mii_mac/*.sv) $(wildcard $(ETHERNET_DIR)/mii_axis/*.sv) $(ETHERNET_DIR)/util/simple_fifo.v

CHISEL_DESIGN_DIR ?= $(ROOT_DIR)/chisel/src/main/scala
CHISEL_DESIGN_SRCS := $(shell find $(CHISEL_DESIGN_DIR) -name "*.scala")

ETHERNET_VIDEO_CORE_ELABORATE_DIR := $(abspath src/$(TARGET)/chisel_output)
ETHERNET_VIDEO_CORE_SRC := $(ETHERNET_VIDEO_CORE_ELABORATE_DIR)/ethernet_video.v

PROJECT_ADDITIONAL_ARGS += $(abspath $(ETHERNET_DIR)) $(abspath $(ETHERNET_VIDEO_CORE_SRC))
PROJECT_ADDITIONAL_CLEAN += $(ETHERNET_VIDEO_CORE_ELABORATE_DIR)/*

SRCS := src/$(TARGET)/pins.cst $(wildcard src/$(TARGET)/*.sdc) $(wildcard src/$(TARGET)/*.sv) project.tcl $(MII_MAC_SRC) $(ETHERNET_VIDEO_CORE_SRC)

PMOD_PORT_OFFSET ?= 0
PMOD_TARGETS := tangnano9k_pmod tangprimer20k

# Check if the target contains PMOD ports
USE_PMOD := 0
ifneq (,$(filter $(TARGET),$(PMOD_TARGETS)))
USE_PMOD := 1
PROJECT_ADDITIONAL_CLEAN += src/$(TARGET)/pins.cst
endif
include ../build_gowin.mk

ifeq ($(TARGET),tangnano9k_pmod)
# Add Pmod Ethernet module
PMOD_MODULES += $(MOD_DIR)/pmod_ethernet/pmod_pins.csv
endif
PMOD_MODULES += $(MOD_DIR)/pmod_hub75/pmod_pins.csv

# Elaborate Chisel sources
$(ETHERNET_VIDEO_CORE_SRC): $(CHISEL_DESIGN_SRCS)
	cd $(ROOT_DIR) && sbt "project fpga_samples; runMain system.ElaborateEthernetVideoSystem $(dir $(abspath $@)) 36000000"

ifeq ($(USE_PMOD),1)
# Generate CST file from template.
src/$(TARGET)/pins.cst: src/$(TARGET)/pins.cst.template $(TARGET_DEF_DIR)/pmod_ports.csv $(PMOD_MODULES) $(MAPPMOD)
	echo Generating pin definition from Pmod pin map.
	echo // This file is automatically generated by build script. DO NOT EDIT THIS FILE. > $@
	cat src/$(TARGET)/pins.cst.template >> $@
	$(MAPPMOD) --pmod-port-def $(TARGET_DEF_DIR)/pmod_ports.csv $(addprefix --pmod ,$(PMOD_MODULES)) --port-offset $(PMOD_PORT_OFFSET) --direction right-to-left >> $@
else
src/$(TARGET)/pins.cst:
	echo Use pre-generated pin definition.
endif